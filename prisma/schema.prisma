// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client"
  output   = "../app/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

model User{
  id       Int   @id @default(autoincrement())
  name     String
  username String   @unique
  email    String?   @unique
  password String
  type     Role
  refreshToken String?
  contactInfo Json?
  dob      DateTime?

  // Email verification and password reset
  emailVerified        Boolean   @default(false)
  emailVerificationToken String?  @unique
  emailVerificationExpiry DateTime?
  passwordResetToken   String?   @unique
  passwordResetExpiry  DateTime?


  // Link to the Broker profile
  brokerId Int?
  broker   User?   @relation("CreatorBrokerRelation", fields: [brokerId], references: [id])
  clients  User[]  @relation("CreatorBrokerRelation")

  // policies created by this broker
  managedPolicies Policy[]


  // Records this user MANAGED as an employee/agent
  managedRecords Record[] @relation("BrokerRelation")
  // count of managed records as broker
  managedCount     Int      @default(0)

  // Records this user MANAGED as a client
  records    Record[] @relation("ClientRelation")
  // count of managed records as client
  clientCount      Int      @default(0)
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("users")
}

enum Role {
  ADMIN
  USER
  BROKER
  CLIENT
}




model Record {
  id           Int      @id @default(autoincrement())
  totalAmount  Decimal  @db.Decimal(20, 2)  
  totalTaxed   Decimal  @db.Decimal(20, 2)
  state        CrmState
  
  // The person who OWNS the policy (The Client)
  clientId     Int
  client       User @relation("ClientRelation", fields: [clientId], references: [id])
  
  // The broker who created the record
  brokerId       Int
  broker        User   @relation("BrokerRelation", fields: [brokerId], references: [id])
  
  policyId     Int
  policy       Policy   @relation(fields: [policyId], references: [id])
  policyDescription String

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("records")
  @@index([clientId])
  @@index([brokerId])
  @@index([policyId])
}

enum CrmState {
  DRAFT
  CONTACTED
  WON
  LOST
}

model Company {
  id       Int      @id @default(autoincrement())
  name     String   @unique
  address  String?
  logo     String?
  policies Policy[]

  @@map("companies")
}

model Policy {
  id        Int      @id @default(autoincrement())
  type      PolicyType
  name      String
  //totalNetPremium Decimal  @db.Decimal(20, 2)
  companyId Int
  company   Company  @relation(fields: [companyId], references: [id])
  tax       Decimal?  @db.Decimal(10, 4)

  brokerId Int?
  broker   User?     @relation(fields: [brokerId], references: [id])
  
  // Relations to Subtypes
  carPolicy    CarPolicy?
  healthPolicy HealthPolicy?
  records      Record[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("policies")
}

enum PolicyType {
  CAR
  HEALTH
  SME
}

model CarPolicy {
  id         Int    @id @default(autoincrement())
  ownDamage  String
  thirdParty String
  fire       String
  theft      String
  make       String
  model      String
  year       Int
  mileage    Int
  
  policyId   Int    @unique
  policy     Policy @relation(fields: [policyId], references: [id])
  
  @@map("car_policies")
}

model HealthPolicy {
  id              Int             @id @default(autoincrement())
  
  // Life Benefits
  lifeInsurance               String
  totalPermanentDisability    String
  accidentalDeath             String
  partialPermanentDisability  String

  // Medical Benefits
  medicalTpa     String
  network          String
  areaOfCoverage   String
  annualCeilingPerPerson String

  // In-Patient Benefits
  inPatientAccommodation String
  icu                    String
  parentAccommodation    String

  // Out-Patient Benefits
  doctorConsultation   String
  labScan                    String
  physiotherapy             String
  medication                 String
  
  // Additional Benefits
  dental           String
  optical           String
  maternityLimit   String
  newbornCeiling  String
  
  // Other Benefits
  preExistingCases String
  newChronic       String
  organTransplant     String
  groundAmbulance     String
  
  // Reimbursement Rules
  reimbursementCoverage     String

  // Enrollment & Pricing
  //numberOfInsuredMembers    Int
  //averagePremiumPerHead     Decimal @db.Decimal(10, 2)
  
  
  policyId        Int             @unique
  policy          Policy          @relation(fields: [policyId], references: [id])
  healthPricings  Json[]
  
  @@map("health_policies")
}

/*type HealthPricing {
  //id           Int    @id @default(autoincrement())
  minAge       Int
  maxAge       Int
  mainPrice     Decimal @db.Decimal(10, 2)
  dependentPrice     Decimal @db.Decimal(10, 2)
  
  //healthId     Int
  //healthPolicy HealthPolicy @relation(fields: [healthId], references: [id])
  
  //@@map("health_pricings")
  //@@index([healthId])
}*/