generator client {
  provider = "prisma-client"
  output   = "../app/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

model User {
  id                      Int       @id @default(autoincrement())
  name                    String
  username                String    @unique
  email                   String    @unique
  password                String
  type                    Role
  createdAt               DateTime  @default(now())
  updatedAt               DateTime  @updatedAt
  brokerId                Int?
  contactInfo             Json?
  clientCount             Int       @default(0)
  dob                     DateTime?
  managedCount            Int       @default(0)
  emailVerificationExpiry DateTime?
  emailVerificationToken  String?   @unique
  emailVerified           Boolean   @default(false)
  passwordResetExpiry     DateTime?
  passwordResetToken      String?   @unique
  leadSource              String?
  refreshTokens           String[]  @default([])
  managedPolicies         Policy[]
  managedRecords          Record[]  @relation("BrokerRelation")
  records                 Record[]  @relation("ClientRelation")
  broker                  User?     @relation("CreatorBrokerRelation", fields: [brokerId], references: [id], onDelete: Cascade)
  clients                 User[]    @relation("CreatorBrokerRelation")

  @@map("users")
}

model Company {
  id       Int      @id @default(autoincrement())
  name     String   @unique
  address  String?
  logo     String?
  policies Policy[]

  @@map("companies")
}

model Record {
  id        Int            @id @default(autoincrement())
  state     CrmState
  createdAt DateTime       @default(now())
  updatedAt DateTime       @updatedAt
  clientId  Int
  brokerId  Int
  issueDate DateTime
  type      PolicyType
  policies  RecordPolicy[]
  broker    User           @relation("BrokerRelation", fields: [brokerId], references: [id], onDelete: Cascade)
  client    User           @relation("ClientRelation", fields: [clientId], references: [id], onDelete: Cascade)

  @@index([clientId])
  @@index([brokerId])
  @@map("records")
}

model RecordPolicy {
  recordId          Int
  policyId          Int
  totalAmount       Decimal @db.Decimal(20, 2)
  totalTaxed        Decimal @db.Decimal(20, 2)
  policyDescription String
  numberOfInsureds  Int
  numberOfPersons   Int
  averageAge        Decimal @db.Decimal(10, 2)
  avgPricePerPerson Decimal @db.Decimal(10, 2)
  policy            Policy  @relation(fields: [policyId], references: [id], onDelete: Cascade)
  record            Record  @relation(fields: [recordId], references: [id], onDelete: Cascade)

  @@id([recordId, policyId])
  @@map("record_policies")
}

model Policy {
  id           Int            @id @default(autoincrement())
  type         PolicyType
  companyId    Int
  tax          Decimal?       @db.Decimal(10, 4)
  createdAt    DateTime       @default(now())
  updatedAt    DateTime       @updatedAt
  brokerId     Int?
  name         String
  carPolicy    CarPolicy?
  healthPolicy HealthPolicy?
  broker       User?          @relation(fields: [brokerId], references: [id], onDelete: Cascade)
  company      Company        @relation(fields: [companyId], references: [id], onDelete: Cascade)
  records      RecordPolicy[]

  @@map("policies")
}

model CarPolicy {
  id         Int    @id @default(autoincrement())
  ownDamage  String
  thirdParty String
  fire       String
  theft      String
  make       String
  model      String
  year       Int
  mileage    Int
  policyId   Int    @unique
  policy     Policy @relation(fields: [policyId], references: [id], onDelete: Cascade)

  @@map("car_policies")
}

model HealthPolicy {
  id                         Int    @id @default(autoincrement())
  lifeInsurance              String
  totalPermanentDisability   String
  accidentalDeath            String
  partialPermanentDisability String
  medicalTpa                 String
  network                    String
  areaOfCoverage             String
  annualCeilingPerPerson     String
  inPatientAccommodation     String
  icu                        String
  parentAccommodation        String
  doctorConsultation         String
  labScan                    String
  physiotherapy              String
  medication                 String
  dental                     String
  optical                    String
  maternityLimit             String
  newbornCeiling             String
  preExistingCases           String
  newChronic                 String
  organTransplant            String
  groundAmbulance            String
  reimbursementCoverage      String
  policyId                   Int    @unique
  healthPricings             Json?
  policy                     Policy @relation(fields: [policyId], references: [id], onDelete: Cascade)

  @@map("health_policies")
}

enum Role {
  ADMIN
  USER
  BROKER
  CLIENT
}

enum CrmState {
  DRAFT
  KYC
  QUOTATION
  REQUEST
  PROPOSITION
  WON
  LOST
}

enum PolicyType {
  CAR
  Individual_Medical
  SME
}
